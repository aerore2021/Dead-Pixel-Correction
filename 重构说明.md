# DPC模块重构说明文档

## 重构概述

本次重构将原有的基于阈值比较的坏点检测算法改为基于k值判断的检测方法，同时保持手动坏点表功能。

## 主要变更

### 1. 检测逻辑变更

**原始版本：**
- 自动检测：基于3×3邻域差值与阈值比较
- 判断条件：所有邻域差值同号且超过阈值(平缓模式) 或 中心值与中值差异超阈值(强力模式)

**重构版本：**
- 自动检测：基于k值判断
- 判断条件：k值为0的像素点判断为坏点
- 优势：更直接、准确，基于NUC校正过程中的k值信息

### 2. 架构变更

**新增接口：**
```verilog
// k值输入流接口
input  wire                            k_axis_tvalid,
input  wire [  AXIS_TDATA_WIDTH-1 : 0] k_axis_tdata,

// 图像尺寸接口  
input  wire [                   15:0] width,
input  wire [                   15:0] height,

// 调试输出接口
output wire                            debug_bad_pixel_detected,
output wire                            debug_manual_bad_pixel,
output wire                            debug_auto_bad_pixel,
```

**移除接口：**
- `threshold`: 不再需要阈值设置
- `smooth`: 不再需要模式选择

### 3. 流水线结构

**7级流水线处理：**
1. **第1级**: 3×3像素窗口生成 + k值窗口缓存
2. **第2级**: 手动坏点检测 (坐标匹配)
3. **第3级**: 自动坏点检测 (k值判断)
4. **第4级**: 坏点合并判断 (手动 OR 自动)
5. **第5级**: 3×3邻域非坏点统计和累加
6. **第6级**: 邻域均值计算
7. **第7级**: 输出选择 (原值/校正值)

### 4. 校正策略变更

**原始版本：**
- 坏点校正：中值滤波
- 手动坏点：邻域均值

**重构版本：**
- 统一校正：3×3邻域中所有非坏点(k≠0)的均值
- 更智能：避免用坏点像素参与校正计算

## 配置方法

### 1. 寄存器配置

```c
// AXI4-Lite寄存器地址映射
#define DPC_BASE_ADDR    0xe1008000
#define REG_GO           (DPC_BASE_ADDR + 0x00)  // 使能控制
#define REG_BAD_NUM      (DPC_BASE_ADDR + 0x04)  // 手动坏点数量
// 地址0x10开始为手动坏点表数据

// 配置示例
*(volatile uint32_t*)REG_GO = 1;        // 使能DPC
*(volatile uint32_t*)REG_BAD_NUM = 5;   // 设置5个手动坏点
```

### 2. 手动坏点表配置

```c
// 坐标格式：高16位=X坐标，低16位=Y坐标
uint32_t bad_points[] = {
    (100 << 16) | 200,  // 坐标(100, 200)
    (150 << 16) | 300,  // 坐标(150, 300)
    (200 << 16) | 400,  // 坐标(200, 400)
    // ... 最多128个坏点
};

// 写入坏点表
for (int i = 0; i < num_bad_points; i++) {
    *(volatile uint32_t*)(DPC_BASE_ADDR + 0x10 + i*4) = bad_points[i];
}
```

### 3. 顶层连接示例

```verilog
// 在video_out_test_top.v中的连接
DpcTop DPC_inst (
    // 时钟复位
    .axis_aclk               (aclk),
    .axis_aresetn            (aresetn),
    
    // 数据流
    .s_axis_tvalid          (nuc_m_axis_tvalid),
    .s_axis_tready          (nuc_m_axis_tready),
    .s_axis_tdata           (nuc_m_axis_tdata),
    .s_axis_tuser           (nuc_m_axis_tuser),
    .s_axis_tlast           (nuc_m_axis_tlast),
    
    // k值流 (从NUC模块获取)
    .k_axis_tvalid          (nuc_k_axis_tvalid),
    .k_axis_tdata           (nuc_k_axis_tdata),
    
    // 输出流
    .m_axis_tvalid          (dpc_m_axis_tvalid),
    .m_axis_tready          (dpc_m_axis_tready),
    .m_axis_tdata           (dpc_m_axis_tdata),
    .m_axis_tuser           (dpc_m_axis_tuser),
    .m_axis_tlast           (dpc_m_axis_tlast),
    
    // 图像尺寸
    .width                  (frame_width),
    .height                 (frame_height),
    
    // AXI4-Lite配置接口
    .s00_axi_aclk           (S_AXI_ACLK),
    .s00_axi_aresetn        (S_AXI_ARESETN),
    .s00_axi_awaddr         (s07_axi_awaddr),
    // ... 其他AXI信号
    
    // 调试输出
    .debug_bad_pixel_detected(debug_dpc_bad_detected),
    .debug_manual_bad_pixel  (debug_dpc_manual),
    .debug_auto_bad_pixel    (debug_dpc_auto)
);
```

## 性能特点

### 1. 检测精度提升
- 基于k值的检测更准确，避免了阈值设置的主观性
- k=0直接对应NUC校正失效的像素，检测准确率高

### 2. 校正质量改善  
- 使用邻域非坏点均值，避免坏点参与校正计算
- 自适应邻域大小，在坏点聚集区域仍能有效校正

### 3. 资源消耗
- 流水线级数不变(7级)
- 取消了复杂的排序网络(中值滤波)
- 增加了k值缓存，但整体资源消耗减少

### 4. 延迟特性
- 处理延迟：7个时钟周期
- 吞吐率：每时钟周期1像素
- 支持实时处理

## 调试功能

重构版本提供了丰富的调试接口：

```verilog
output wire debug_bad_pixel_detected,  // 当前像素是否被检测为坏点
output wire debug_manual_bad_pixel,    // 手动坏点检测结果
output wire debug_auto_bad_pixel,      // 自动坏点检测结果(k值判断)
```

可以通过ILA(Integrated Logic Analyzer)监控这些信号来分析坏点检测效果。

## 兼容性说明

### 1. 向上兼容
- 保持AXI4-Lite配置接口兼容
- 保持AXI Stream数据接口兼容
- 手动坏点表格式不变

### 2. 新增依赖
- 需要NUC模块提供k值数据流
- 需要提供图像尺寸参数
- BRAM资源需求略有增加

### 3. 配置简化
- 不再需要配置threshold和smooth参数
- 配置流程更简单直观

## 总结

重构后的DPC模块具有以下优势：
1. **检测准确性更高**：基于k值判断比阈值比较更可靠
2. **校正质量更好**：使用邻域非坏点均值避免二次污染  
3. **配置更简单**：移除了复杂的参数设置
4. **调试更便利**：提供了丰富的调试接口
5. **与NUC协同**：充分利用NUC模块的k值信息

这种设计使得整个图像处理链更加协调统一，提高了坏点处理的整体效果。
